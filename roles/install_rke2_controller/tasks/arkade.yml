---
# As Admin User
- name: Prepare arkade packages
  become: true
  become_user: "{{ admin_user }}"
  block:
    - name: Ensure Arkade directory exist
      ansible.builtin.file:
        path: "$HOME/.arkade/bin"
        state: directory
        recurse: true
        owner: "{{ admin_user }}"
        group: "{{ admin_user }}"
        mode: '0700'

    - name: Update .bashrc
      ansible.builtin.blockinfile:
        path: "$HOME/.bashrc"
        block: |
          export PATH=$PATH:$HOME/.arkade/bin
        marker: "# {mark} ANSIBLE install arkade utils"

# As root
- name: Import arkade packages
  become: true
  block:
    - name: Copy utils into .arkade/bin
      ansible.builtin.copy:
        src: "{{ mount_utils_path }}/{{ item }}"
        dest: "$HOME/.arkade/bin/{{ item }}"
        force: true
        remote_src: true
        mode: '0700'
      loop:
        - yq
        - jq
        - helm
        - just
        - kubectl
        - k9s

    - name: Ensure admin user access arkade utils
      ansible.builtin.file:
        path: "$HOME/.arkade/bin/{{ item }}"
        owner: "{{ admin_user }}"
        group: "{{ admin_user }}"
        recurse: true
