<h1 style="text-align: center;"><code> Ansible Collection - Rkub  </code></h1>

Ansible Collection to deploy a rancher RKE2 cluster in airgap mode.

[![Releases](https://img.shields.io/github/release/MozeBaltyk/rkub)](https://github.com/MozeBaltyk/rkub/releases)
[![License: Apache-2.0](https://img.shields.io/badge/License-Apache%202.0-green.svg)](https://opensource.org/licenses/Apache-2.0/)

## Description

Ansible collection met to install in airgap environnement RKE2 (one controler and several workers, currently no HA):

<!-- Autogenerated -->
  - [RKE2 1.26.11](https://docs.rke2.io) - Security focused Kubernetes
  - [Rancher 2.8.0](https://www.suse.com/products/suse-rancher/) - Multi-Cluster Kubernetes Management
  - [Longhorn 1.5.3](https://longhorn.io) - Unified storage layer
  - [Neuvector 2.6.6](https://neuvector.com/) - Kubernetes Security Platform
<!-- END -->

This Project is mainly inspired from [Clemenko/rke_airgap_install](https://github.com/clemenko/rke_airgap_install/blob/main/air_gap_all_the_things.sh). 
I tried it and like the idea but I was frustrated with Shell scripting limitations. So I decided to rewrite it in Ansible.  

With Ansible:   
* Idempotency: can be relaunch multiple time.    
* User agnostic: can be launch by any user (with sudo rights).   
* OS agnositc: can be launch on any Linux systems (at least for the package build, for the install depend on your participation to this project ðŸ˜¸)   

Add-on from my part:   
* Some part which were manual in Clemenko procedure are automated with Ansible (like the upload)  
* Some flexibility about path (possible to export or mount NFS in choosen place)  
* Arkade to install utilities binaries  
* Admin user (by default kuberoot) on first controler node with all necessary tools  
* Nerdctl (as complement of containerd)   
* Firewalld settings if firewalld running   
* Uninstall playbook to cleanup (and maybe reinstall if needed)   
* Collection Released, so possibilty to get back to older versions   

## Prerequisites

* Linux Host as a package builder (can be a VM or your WSL)

* An Ansible Controler, can be the same host for ansible and for building package, at your convenience...

* A minimum of 2 hosts RHEL-like for the cluster RKE2 with 80G at least on target directory.

## Getting started

1. Preparation steps:     
- Clone this project on local machine which have an internet access.   
- Execute `make prerequis` to install all prerequisites.
- Complete directory inside `./plugins/inventory/hosts.yml`. 

2. Build your package by running (works on Debian-like and Redhat-like):  
```sh 
ansible-playbook playbooks/tasks/build.yml         # All arguments below are not mandatory
-e dir_build="$HOME/rkub"                          # Directory where to upload everything (count 30G)
-e package_name="rke2_rancher_longhorn.zst"        # Name of the package, by default rke2_rancher_longhorn.zst
-u admin -Kk                                       # Other Ansible Arguments (like -vvv)
```

Count 30G of free space in your build directory (17G for download + 7G for the zst package).

3. Push your package to first controler:  
```sh
ansible-playbook playbooks/tasks/upload.yml        # All arguments below are not mandatory
-e package_path=/home/me/rke2_rancher_longhorn.zst # Will be prompt if not given in the command
-e dir_target=/opt                                 # Directory where to sync and unarchive (by default /opt, count 50G available) 
-u admin -Kk                                       # Other Ansible Arguments (like -vvv)   
```

4. Start installation: 
```sh
ansible-playbook playbooks/tasks/install.yml       # All arguments below are not mandatory
-e dir_target=/opt                                 # Dir on first master which is going to be export (by default /opt, count 50G available) 
-e dir_mount=/mnt/rkub                             # NFS mount point (on first master, it will be a symlink to "dir_target")
-e domain="example.com"                            # By default take the host domain from master server 
-u admin -Kk                                       # Other Ansible Arguments (like -vvv)
```

5. Deploy Rancher:
```sh
ansible-playbook playbooks/tasks/rancher.yml       # All arguments below are not mandatory
-e dir_mount=/mnt/rkub                             # NFS mount point, by default value is /mnt/rkub
-e domain="example.com"                            # Domain use for ingress, by default take the host domain from master server 
-e password="BootStrapAllTheThings"                # Default password is "BootStrapAllTheThings"
-u admin -Kk                                       # Other Ansible Arguments (like -vvv)
```

6. Deploy Longhorn:
```sh
ansible-playbook playbooks/tasks/longhorn.yml      # All arguments below are not mandatory
-e dir_mount=/mnt/rkub                             # NFS mount point, by default value is /mnt/rkub
-e domain="example.com"                            # Domain use for ingress, by default take the host domain from master server
-e datapath="/opt/longhorn"                        # Longhorn Path for PVC, by default equal "{{ dir_target }}/longhorn". 
                                                   # The best is to have a dedicated LVM filesystem for this one. 
-u admin -Kk                                       # Other Ansible Arguments (like -vvv)
```

7. Deploy Neuvector
```sh
ansible-playbook playbooks/tasks/neuvector.yml     # All arguments below are not mandatory
-e dir_mount=/mnt/rkub                             # NFS mount point, by default value is /mnt/rkub
-e domain="example.com"                            # Domain use for ingress, by default take the host domain from master server
-u admin -Kk                                       # Other Ansible Arguments (like -vvv)
```

## Roadmap
milestones:  
* Improve collection to run as true collection
* Ansible Execution-Env 
* More install customization and options
* To add bootstrap with ArgoCD
* HA masters with kubevip 

Improvment:
* Add a option to chooce by url mode or airgap mode


# Special thanks to ðŸ“¢

* Clemenko, for the idea [Clemenko/rke_airgap_install](https://github.com/clemenko/rke_airgap_install/blob/main/air_gap_all_the_things.sh).

* Alex Ellis, for its [Arkade project](https://github.com/alexellis/arkade). I cannot live without anymore.

## Github sources 

[Clemenko/rke_airgap_install](https://github.com/clemenko/rke_airgap_install/blob/main/air_gap_all_the_things.sh)   

[rancherfederal/RKE2-ansible](https://github.com/rancherfederal/rke2-ansible)

[lablabs/ansible-role-rke2](https://github.com/lablabs/ansible-role-rke2)     

[rancher/RKE2](https://github.com/rancher/rke2)


## Authors
morze.baltyk@proton.me


## Project status
Still on developement
